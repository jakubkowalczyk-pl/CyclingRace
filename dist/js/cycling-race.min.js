/*!
* CyclingRace v1.0.0
* http://jgallery.jakubkowalczyk.pl/
*
* Date: 2015-08-29
*/
!function(){"use strict";var a=angular.module("cyclingRace",[]),b=function(){var a=this;this.speed=0,this.cadence=0,this.distance=0,this.maxRearDerailleur=10,this.rearDerailleur=1,this.leftPedal=new f,this.rightPedal=new f({position:180}),this.control=new d({bike:this}),this.pressingLeftPedal=null,this.pressingRightPedal=null,this.pressingInterval=40,this.biker=null,this.gravity=new e({object:this}),setInterval(function(){a.distance+=1e3*a.speed/60/60/25},40)};b.prototype={constructor:b,pressLeftPedal:function(){var a=this;this.pressingRightPedal?this.stopPressPedals():this.pressingLeftPedal||(this.pressingLeftPedal=setInterval(function(){a.rotateCrank(a.leftPedal)},this.pressingInterval))},stopPressLeftPedal:function(){clearInterval(this.pressingLeftPedal),this.pressingLeftPedal=null,this.cadence=0},pressRightPedal:function(){var a=this;this.pressingLeftPedal?this.stopPressPedals():this.pressingRightPedal||(this.pressingRightPedal=setInterval(function(){a.rotateCrank(a.rightPedal)},this.pressingInterval))},stopPressRightPedal:function(){clearInterval(this.pressingRightPedal),this.pressingRightPedal=null,this.cadence=0},pressBrake:function(){this.speed=0},rearDerailleurUp:function(){this.rearDerailleur=Math.min(this.rearDerailleur+1,this.maxRearDerailleur)},rearDerailleurDown:function(){this.rearDerailleur=Math.max(this.rearDerailleur-1,1)},rotateCrank:function(a){if(a.position<f.POSITION_DOWN){var b=Math.round((10+this.speed)/this.rearDerailleur*2);this.cadence=Math.min(b/360*6e4/this.pressingInterval,this.biker.maxCadence),this.speed+=.1*Math.sqrt(this.rearDerailleur),this.leftPedal.position+=b,this.rightPedal.position+=b,a.position>f.POSITION_DOWN&&(a.position=f.POSITION_DOWN),this.leftPedal.position>=360&&(this.leftPedal.position=0),this.rightPedal.position>=360&&(this.rightPedal.position=0)}else this.cadence=0},stopPressPedals:function(){this.stopPressLeftPedal(),this.stopPressRightPedal()}};var c=function(a){this.name=a.name,this.bike=a.bike,this.maxCadence=80};c.prototype={constructor:c};var d=function(a){angular.element(document).bind("keydown",function(b){switch(b.keyCode){case 37:a.bike.pressLeftPedal();break;case 39:a.bike.pressRightPedal();break;case 35:a.bike.pressBrake()}}).bind("keyup",function(b){switch(b.keyCode){case 37:a.bike.stopPressLeftPedal();break;case 39:a.bike.stopPressRightPedal();break;case 38:a.bike.rearDerailleurUp();break;case 40:a.bike.rearDerailleurDown()}})};d.prototype={constructor:d};var e=function(a){this.object=a.object,setInterval(function(){a.object.speed=Math.max(0,a.object.speed-1)},800)};e.prototype={constructor:e};var f=function(a){a=a||{},this.position=a.position||0};f.POSITION_UP=0,f.POSITION_DOWN=180,f.prototype={constructor:f};var g=function(a){this.route=a.route,this.bikers=a.bikers};g.prototype={constructor:g};var h=function(a){this.route=a.distance};h.prototype={constructor:h};var i=function(a){var b=this;this.scene=new THREE.Scene,this.camera=new THREE.PerspectiveCamera(75,window.innerWidth/window.innerHeight,.1,1e3),this.renderer=new THREE.WebGLRenderer,this.sky=this.createSky(),this.grass=this.createGrass(),this.road=this.createRoad(),this.renderer.setSize(window.innerWidth,window.innerHeight),this.body.appendChild(this.renderer.domElement),this.road.translateZ(1e-6),this.grass.add(this.road),this.grass.rotateOnAxis(new THREE.Vector3(-1,0,0),1.5),this.grass.translateY(-10),this.scene.add(this.sky),this.scene.add(this.grass),this.camera.position.z=1.25,setInterval(function(){var c=.001*a.speed;b.road.texture.offset.y+=c,b.grass.texture.offset.y+=c},40)};i.prototype={body:document.querySelectorAll("body")[0],createSky:function(){return new THREE.Mesh(new THREE.PlaneGeometry(10,20,32),new THREE.MeshBasicMaterial({map:function(){var a=THREE.ImageUtils.loadTexture("./img/sky.jpg");return a.wrapS=THREE.RepeatWrapping,a.wrapT=THREE.RepeatWrapping,a.repeat.set(1,4.001),a}()}))},createGrass:function(){var a=function(){var a=THREE.ImageUtils.loadTexture("./img/grass.jpg");return a.wrapS=THREE.RepeatWrapping,a.wrapT=THREE.RepeatWrapping,a.repeat.set(12,60),a}(),b=new THREE.Mesh(new THREE.PlaneGeometry(10,20,32),new THREE.MeshBasicMaterial({map:a}));return b.texture=a,b},createRoad:function(){var a=function(){var a=THREE.ImageUtils.loadTexture("./img/Asphalt-913.jpg");return a.wrapS=THREE.RepeatWrapping,a.wrapT=THREE.RepeatWrapping,a.repeat.set(2,60),a}(),b=new THREE.Mesh(new THREE.PlaneGeometry(.5,20,32),new THREE.MeshBasicMaterial({map:a}));return b.texture=a,b}},a.directive("cyclingRace",[function(){return{link:function(a){function d(){requestAnimationFrame(d),e.renderer.render(e.scene,e.camera)}a.time=new Date(0),a.bikers=[],a.bikers.push(new c({name:"Player1",bike:new b})),a.bikers[0].bike.biker=a.bikers[0],a.route=new h({distance:5e3}),new g({bikers:a.bikers,route:a.route});var e=new i(a.bikers[0].bike);d(),setInterval(function(){a.time.setMilliseconds(a.time.getMilliseconds()+40),a.$digest()},40)}}}])}();