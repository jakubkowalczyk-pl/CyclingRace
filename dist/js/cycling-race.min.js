/*!
* CyclingRace v1.0.0
*
* Date: 2015-09-14
*/
!function(){"use strict";var a=angular.module("cyclingRace",[]),b=function(a){var b=this;this.route=a.route,this.speed=0,this.distance=0,this.gravity=new k({object:this}),this.timer=new o,setInterval(function(){b.distance>=b.route.distance&&b.timer.stop()},1e3)};b.prototype={constructor:b,pressBrake:function(){this.speed=0}};var c=function(){var a=function(){var a=this;this.update=function(){},setInterval(function(){a.update()},40)};return a.prototype={constructor:a,add:function(a){var b=angular.copy(this.update);this.update=function(){b(),a()}}},new a}(),d=function(){var a=this;c.add(function(){a.periodicallyUpdate()})};d.prototype={constructor:d};var e=function(a){angular.element(document).bind("keydown",function(b){switch(b.keyCode){case 37:a.bike.turnLeft();break;case 39:a.bike.turnRight();break;case 88:a.bike.pressLeftPedal();break;case 67:a.bike.pressRightPedal();break;case 35:a.bike.pressBrake()}}).bind("keyup",function(b){switch(b.keyCode){case 88:a.bike.stopPressLeftPedal();break;case 67:a.bike.stopPressRightPedal();break;case 38:a.bike.rearDerailleurUp();break;case 40:a.bike.rearDerailleurDown()}})};e.prototype={constructor:e};var f=function(a){b.call(this,a),d.call(this),this.cadence=0,this.maxRearDerailleur=10,this.rearDerailleur=4,this.translate=new p,this.rotate=new l,this.leftPedal=new i,this.rightPedal=new i({position:180}),this.control=new e({bike:this}),this.pressingLeftPedal=!1,this.pressingRightPedal=!1,this.turningLeft=null,this.turningRight=null,this.pressingInterval=40,this.biker=null,this.prevCrankMove=null};f.prototype=angular.extend(b.prototype,{constructor:f,pressLeftPedal:function(){this.pressingRightPedal?this.stopPressPedals():this.pressingLeftPedal||(this.pressingLeftPedal=!0)},stopPressLeftPedal:function(){this.pressingLeftPedal=!1,this.cadence=0,this.prevCrankMove=null},pressRightPedal:function(){this.pressingLeftPedal?this.stopPressPedals():this.pressingRightPedal||(this.pressingRightPedal=!0)},stopPressRightPedal:function(){this.pressingRightPedal=!1,this.cadence=0,this.prevCrankMove=null},rearDerailleurUp:function(){this.rearDerailleur=Math.min(this.rearDerailleur+1,this.maxRearDerailleur)},rearDerailleurDown:function(){this.rearDerailleur=Math.max(this.rearDerailleur-1,1)},rotateCrank:function(a){if(a.position<i.POSITION_DOWN){var b=new Date,c=this.prevCrankMove?b-this.prevCrankMove:0,d=1.5*Math.round(.75*(14-1.3*this.rearDerailleur)+.15*this.speed);this.prevCrankMove=b,c&&(this.cadence=Math.min(d/360*6e4/c,this.biker.maxCadence),this.speed+=.01*Math.sqrt(this.rearDerailleur)*this.cadence/4*c/this.pressingInterval,this.distance+=this.speed*c/3600),this.leftPedal.position+=d,this.rightPedal.position+=d,a.position>i.POSITION_DOWN&&(a.position=i.POSITION_DOWN),this.leftPedal.position>=360&&(this.leftPedal.position=0),this.rightPedal.position>=360&&(this.rightPedal.position=0)}else this.cadence=0},stopPressPedals:function(){this.stopPressLeftPedal(),this.stopPressRightPedal()},periodicallyUpdate:function(){var a=.001*this.speed*Math.sin(this.rotate.y),b=.001*this.speed*Math.cos(this.rotate.y),c=this.getWorkingPedal();c&&this.rotateCrank(c),this.translate.x+=a,this.translate.y+=b},getWorkingPedal:function(){return this.pressingLeftPedal?this.leftPedal:this.pressingRightPedal?this.rightPedal:void 0},startTurningLeft:function(){this.turningRight?this.stopTurning():this.turningLeft||(this.turningLeft=!0)},stopTurningLeft:function(){this.turningLeft=!1,this.rotate.y=0},startTurningRight:function(){this.turningLeft?this.stopTurning():this.turningRight||(this.turningRight=!0)},stopTurningRight:function(){this.turningRight=!1,this.rotate.y=0},turnLeft:function(){this.rotate.y-=Math.PI/180},turnRight:function(){this.rotate.y+=Math.PI/180},stopTurning:function(){this.stopTurningLeft(),this.stopTurningRight()}});var g=function(a){this.name=a.name,this.bike=a.bike,this.maxCadence=80};g.prototype={constructor:g};var h=function(){this.complete=!1,this.deferred=Q.defer()};h.prototype={constructor:h,markAsCompleted:function(){this.complete=!0,this.deferred.resolve()},isCompleted:function(){return this.complete},whenCompleted:function(){return this.deferred.promise}};var i=function(a){a=a||{},this.position=a.position||0};i.POSITION_UP=0,i.POSITION_DOWN=180,i.prototype={constructor:i};var j=function(a){this.route=a.route,this.bikers=a.bikers};j.prototype={constructor:j};var k=function(a){this.object=a.object,setInterval(function(){a.object.speed*=.92},800)};k.prototype={constructor:k};var l=function(){this.y=0};l.prototype={constructor:l};var m=function(a){this.distance=a.distance};m.prototype={constructor:m};var n=function(){this.name=n.LOADING};n.MENU="Menu",n.RACE="Race",n.LOADING="Loading",n.prototype={constructor:n,set:function(a){this.name=a}};var o=function(){this.value=new Date(0),this.interval=null};o.prototype={constructor:o,start:function(){var a=this;this.interval=setInterval(function(){a.value.setMilliseconds(a.value.getMilliseconds()+1e3)},1e3)},stop:function(){clearInterval(this.interval)}};var p=function(){this.x=0,this.y=0};p.prototype={constructor:p};var q=function(a){angular.element(document).bind("keydown",function(b){switch(b.keyCode){case 65:a.view.camera.position.x-=.1;break;case 68:a.view.camera.position.x+=.1;break;case 87:a.view.camera.position.z-=.1;break;case 83:a.view.camera.position.z+=.1;break;case 81:a.view.camera.rotation.y-=Math.PI/40;break;case 69:a.view.camera.rotation.y+=Math.PI/40}})};q.prototype={constructor:q};var r=function(a){function b(){var a=c.bikeModel,d=c.camera.position,e=8e-5*Math.abs(Math.min(a.leftPedal.position,a.rightPedal.position)-i.POSITION_DOWN/2);c.grass.position.x=-a.translate.x,c.grass.position.z=a.translate.y,d.y=r.CAMERA_POSITION_Y_DEFAULT+e,a.leftPedal.position<a.rightPedal.position?d.x=8e-5*(Math.min(a.leftPedal.position,a.rightPedal.position)-i.POSITION_DOWN/2):d.x=8e-5*(i.POSITION_DOWN/2-Math.min(a.leftPedal.position,a.rightPedal.position)),d.x+=a.translate.x,c.bike.position.x=a.translate.x,c.bike.position.y=a.translate.y,c.camera.rotation.y=-a.rotate.y,c.bike.rotation.y=a.rotate.y,requestAnimationFrame(b),c.renderer.render(c.scene,c.camera)}var c=this,d=window.innerWidth,e=window.innerHeight;this.bikeModel=a.bike,this.loading=a.loading,this.scene=new THREE.Scene,this.camera=new THREE.PerspectiveCamera(75,d/e,.1,1e3),this.renderer=new THREE.WebGLRenderer,this.loader=new THREE.JSONLoader,this.sky=this.createSky(),this.grass=this.createGrass(),this.road=this.createRoad(),this.renderer.setSize(d,e),this.body.appendChild(this.renderer.domElement),this.road.translateZ(4e-6),this.grass.add(this.road),this.grass.rotation.x=-Math.PI/2,this.scene.add(this.sky),this.sky.translateY(2),this.scene.add(this.grass),this.createBike().then(function(a){c.loading.markAsCompleted(),c.bike=a,b()}),this.camera.position.y=r.CAMERA_POSITION_Y_DEFAULT,this.camera.position.z=5.1,this.control=new q({view:this});var f=new THREE.AmbientLight(13619151);this.scene.add(f)};r.CAMERA_POSITION_Y_DEFAULT=.2,r.prototype={body:document.querySelectorAll("body")[0],createSky:function(){return new THREE.Mesh(new THREE.PlaneGeometry(20,1,128),new THREE.MeshBasicMaterial({map:function(){var a=THREE.ImageUtils.loadTexture("./img/sky.jpg");return a.wrapS=THREE.RepeatWrapping,a.wrapT=THREE.RepeatWrapping,a.repeat.set(1,.2001),a}()}))},createGrass:function(){var a=function(){var a=THREE.ImageUtils.loadTexture("./img/grass.jpg");return a.wrapS=THREE.RepeatWrapping,a.wrapT=THREE.RepeatWrapping,a.repeat.set(12,60),a}(),b=new THREE.Mesh(new THREE.PlaneGeometry(13,10,32),new THREE.MeshBasicMaterial({map:a}));return b.texture=a,b},createRoad:function(){var a=function(){var a=THREE.ImageUtils.loadTexture("./img/Asphalt-913.jpg");return a.wrapS=THREE.RepeatWrapping,a.wrapT=THREE.RepeatWrapping,a.repeat.set(2,60),a}(),b=new THREE.Mesh(new THREE.PlaneGeometry(.5,10,32),new THREE.MeshBasicMaterial({map:a}));return b.texture=a,b},createBike:function(){var a=this,b=Q.defer();return this.loader.load("./models/bike.json",function(c,d){var e=new THREE.MeshFaceMaterial(d),f=new THREE.Mesh(c,e);f.scale.x=f.scale.y=f.scale.z=.0125,a.road.add(f),f.rotateOnAxis(new THREE.Vector3(1,0,0),Math.PI/2),f.rotateOnAxis(new THREE.Vector3(0,1,0),Math.PI),f.position.y=-4.97,f.position.z=.069,b.resolve(f)}),b.promise},createTree:function(){var a=this;this.loader.load("./models/tree.json",function(b,c){var d=new THREE.MeshFaceMaterial(c),e=new THREE.Mesh(b,d);e.scale.x=e.scale.y=e.scale.z=.3,a.road.add(e),e.rotateOnAxis(new THREE.Vector3(1,0,0),Math.PI/2),e.position.y=5.03,e.position.z=.069,e.position.x=.15,window.tree=e})}},a.directive("cyclingRace",[function(){return{link:function(a){a.state=new n,a.State=n,a.Pedal=i,a.route=new m({distance:50}),a.bikers=[],a.bikers.push(new g({name:"Player1",bike:new f({route:a.route})})),a.bikers[0].bike.biker=a.bikers[0];var b=(new j({bikers:a.bikers,route:a.route}),new h);new r({bike:a.bikers[0].bike,loading:b});b.whenCompleted().then(function(){a.state.set(n.MENU),a.$digest()}),a.timer=a.bikers[0].bike.timer,setInterval(function(){a.$digest()},100)}}}])}();